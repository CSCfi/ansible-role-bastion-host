---
- name: Generate random name for bastion Heat stack
  register: heat_stack_name_gen
  shell: |
    echo -n "bastion-"
    grep -E "^[a-z]{3,6}$" /usr/share/dict/words | shuf -n 3 | xargs | tr " " "-"
  when: heat_stack_name is undefined

- name: Set a random Heat stack name
  set_fact:
    heat_stack_name: "{{ heat_stack_name_gen.stdout }}"
  when: heat_stack_name is undefined

- name: Print the stack name that will be used
  debug: var=heat_stack_name

- name: Build the bastion host Heat stack
  register: heat_stack
  os_stack:
    name: "{{ heat_stack_name }}"
    state: present
    template: "{{ role_pathÂ }}/files/bastion-heat-stack.yml"
    environment:
      - "{{ heat_environment_file }}"

- name: Add the bastion host to Ansible inventory
  add_host:
    name: "bastion"
    groups: "{{ item.metadata.ansible_group }}"
    ansible_ssh_host: "{{ item.addresses[public_net_name][1].addr }}"
    ansible_ssh_user: "{{ vm_user_account }}"
  with_items:
    - "{{ heat_stack.stack.outputs[0].output_value }}"

- name: Generate an inventory file
  template:
    src: bastion-inventory.j2
    dest: "{{ role_path }}/../../inventories/{{ heat_stack_name }}-autogen-inventory"
